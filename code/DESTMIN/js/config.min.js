jQuery.noConflict();
(async function(a,k,L){let u=window.language_pack(),M=a("#save"),N=a("#cancel"),A=a("#tran_url"),F=a("#header_1"),G=a("#header_2"),H=a("#header_3"),v,r=kintone.plugin.app.getConfig(L),B;try{let p={app:kintone.app.getId()};B=await kintone.api("/k/v1/preview/form","GET",p)}catch(p){return k.fire("Error",p.message||p,"error")}const w=()=>{2===a("#table_language_list tbody > tr").length?a("#table_language_list tbody > tr .removeRowLanguageList").eq(1).hide():a(".removeRowLanguageList").show()},x=()=>
{2===a("#table_translate_field tbody > tr").length?a("#table_translate_field tbody > tr .removeRowTranslateField").hide():a(".removeRowTranslateField").show()};a(document).ready(function(){function p(d){q=d;return y="google_tran_api"==q?u.google_tran_api:"deepl_api"==q?u.deepl_api:"my_memory_api"==q?u.my_memory_api:[]}async function C(d,c){let h,b;for(let e=0;e<d.length;e++){b=d[e];h=a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection'] option:selected").val();c.some(f=>
f.language===h)||"-----"===h||(h="-----");a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection'] > option").remove();a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection']").append(new Option("-----","-----"));for(let f=0;f<c.length;f++){let g=c[f].language;a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection']").append(new Option(g,g))}a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection']").val(h).change()}z=
a("input[name='engine']:checked").val()}async function O(){let d=[],c="";B.properties.forEach(b=>{"SINGLE_LINE_TEXT"===b.type||"RICH_TEXT"===b.type||"MULTI_LINE_TEXT"===b.type?(c={key:b.code,value:b.label+" ("+b.code+")",subtableCode:""},d.push(c)):"SUBTABLE"===b.type&&b.fields.forEach(e=>{c={key:e.code,value:b.label+" ("+b.code+"."+e.code+")",subtableCode:b.code};d.push(c)})});let h=d.sort((b,e)=>b.value.localeCompare(e.value));for(let b=0;b<a("#table_translate_field tbody tr").length;b++)a.each(h,
function(e,f){e=f.key;let g=f.value;f=f.subtableCode;a(`#table_translate_field tbody tr:eq(${b}) select[name='select_field_translate']`).append("<option value="+e+" subtable_check="+f+"> "+g+"</option>")})}async function I(){let d=!1,c=[],h=a("#table_language_list tbody > tr").length;for(var b=2;b<=h;b++){if("-----"==a("#table_language_list tbody > tr:nth-child("+b+") select[name='language-selection'] option:selected").val()){k.fire({icon:"error",title:"Oops...",text:"Please select the language!!"});
return}if(""==a("#table_language_list tbody > tr:nth-child("+b+") input[name='button_label']").val()){k.fire({icon:"error",title:"Oops...",text:"Please enter the Button label!!"});return}}a("#table_language_list tbody > tr > td select[name='language-selection'] option:selected").each(function(){let e=a(this).val();c.includes(e)?(k.fire({icon:"error",title:"Oops...",text:"Your language list choices have the same language.!!"}),d=!0):c.push(e)});if(!d){let e=[];b="";a("#table_translate_field tbody tr").each(function(f){0!==
f&&a(`#table_translate_field tbody tr:eq(${f})> td select[name='select_field_translate']`).each(function(g){g={row:f,language:a(this).attr("value-for-check-field"),field:a(this).val()};e.push(g)})});a("select[name='default_lang'] > option:selected").val()||(b=a("select[name='default_lang'] > option:selected").val());a("select[name='default_lang'] > option").remove();a("#table_translate_field > thead > tr > th:nth-child(n+3)").remove();a("#table_translate_field > tbody > tr:nth-child(n+1) > td:nth-child(n+3)").remove();
a("select[name='default_lang']").append(new Option("-----","-----"));for(let f=2;f<=h;f++){let g=a("#table_language_list tbody > tr:nth-child("+f+") input[name='code_iso']").val(),l=a("#table_language_list tbody > tr:nth-child("+f+") select[name='language-selection']").val(),m=a("#table_language_list tbody > tr:nth-child("+f+") input[name='button_label']").val(),n=l+"("+g.toUpperCase()+")";"-----"!==l&&(a("select[name='default_lang']").append("<option value="+g+" value-for-check="+l+">"+n+"</option>"),
g==b&&a("select[name='default_lang']").val(g).change(),a("#table_translate_field > thead > tr").append(`<th class="kintoneplugin-table-th"><span class="title">${m}</span></th>`),a("#table_translate_field > tbody > tr").append(`<td>
                <div class="kintoneplugin-table-td-control">
                  <div class="kintoneplugin-table-td-control-value">
                    <div class="kintoneplugin-input-outer">
                      <div class="kintoneplugin-select">
                        <select name="select_field_translate" value-for-check-field="${l}" class="select_field_translate">
                          <option value="">-----</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </td>`))}await O();a("#table_translate_field tbody tr").each(function(f){let g=f+1;a(`#table_translate_field tbody tr:eq(${g})> td select[name='select_field_translate']`).each(function(l,m){for(l=0;l<e.length;l++){const n=e[l].language;e[l].row==g&&a(m).attr("value-for-check-field")==n&&a(m).val(e[l].field).change()}})});a("#table_translate_field tbody>tr").append('<td style="display: flex;" class="kintoneplugin-table-td-operation">\n              <button type="button" class="kintoneplugin-button-add-row-image addRowTranslateField" title="Add row"></button>\n              <button type="button" class="kintoneplugin-button-remove-row-image removeRowTranslateField" title="Delete this row"></button>\n          </td>');
x()}}let q=a("input[name='engine']:checked").val(),z=a("input[name='engine']:checked").val(),y=u.google_tran_api,D=a("input[name='tran_direction']:checked").val();a(document).on("change","input[name='tran_direction']",function(){a("input[name='tran_direction']").each(function(){a(this).removeAttr("checked")});a(this).prop("checked",!0);D=a("input[name='tran_direction']:checked").val()});a(document).on("change","input[name='engine']",async function(){let d=a(this).val();v=await p(d);let c=[],h=!0;
a("select[name='language-selection']").each(function(b){let e=a(this).val();v.some(f=>f.language===e)||"-----"===e||(h=!1);c.push(b)});h?C(c,v):k.fire({title:"Are you sure?",text:"Have language not match",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, delete it!"}).then(b=>{b.isConfirmed?(C(c,v),k.fire("Deleted!","Your language has been deleted.","success")):b.isDismissed&&(p(z),a("input[name='engine'][value="+z+"]").prop("checked",
!0))})});const P=()=>{let d={type:q,url:a(A).val(),headers:[{header:a(F).val()||""},{header:a(G).val()||""},{header:a(H).val()||""}]},c=[];a("#table_language_list > tbody tr").each(function(b){0!==b&&c.push({language:a(`#table_language_list tbody tr:eq(${b})> td select[name='language-selection'] option:selected`).val(),button_label:a(`#table_language_list tbody tr:eq(${b})> td input[name='button_label']`).val(),lang_code:a(`#table_language_list tbody tr:eq(${b})> td input[name='lang_code']`).val(),
iso:a(`#table_language_list tbody tr:eq(${b})> td input[name='code_iso']`).val()})});let h=[];a("#table_translate_field tbody tr").each(function(b){if(0!==b){let e=[];a(`#table_translate_field tbody tr:eq(${b})> td select[name='select_field_translate']`).each(function(f){f={iso:a(`#table_language_list tbody tr:eq(${f+1})> td input[name='code_iso']`).val(),field:a(this).val()};e.push(f)});h.push({item_code:a(`#table_translate_field tbody tr:eq(${b})> td input[name='item_code']`).val(),space_element:a(`#table_translate_field tbody tr:eq(${b})> td select[name='select_field_space'] option:selected`).val(),
target_fields:e})}});return{translate_direction:D,translate_engine:JSON.stringify(d),language_list:JSON.stringify(c),default_language:a("select[name='default_lang'] option:selected").val(),translate_fields:JSON.stringify(h)}};a(document).on("click",".addRowLanguageList",function(){let d=a("#table_language_list tbody > tr").eq(0).clone(!0);a(this).parent().parent().after(d);w()});a(document).on("click",".addRowTranslateField",function(){let d=a("#table_translate_field > tbody > tr").eq(0).clone(!0);
a(this).parent().parent().after(d);x()});a(document).on("click",".removeRowLanguageList",function(){a(this).parent("td").parent("tr").remove();w()});a(document).on("click",".removeRowTranslateField",function(){a(this).parent("td").parent("tr").remove();x()});a(document).on("change","select[name='language-selection']",function(){let d=a(this).val();if("-----"==d){var c=a(this).parents("tr").index()+1;a(`#table_language_list tbody > tr:nth-child(${c}) input[name='code_iso']`).val("");a(`#table_language_list tbody > tr:nth-child(${c}) input[name='lang_code']`).val("")}else{c=
y.filter(function(e){return e.language===d});let h=c[0].iso,b=c[0].code;c=a(this).parents("tr").index()+1;a(`#table_language_list tbody > tr:nth-child(${c}) > td input[name='code_iso']`).val(h.toUpperCase());a(`#table_language_list tbody > tr:nth-child(${c}) > td input[name='lang_code']`).val(b)}});a("#table_language_list tbody > tr").on("dragstart",function(d){a(this).addClass("dragging");d.originalEvent.dataTransfer.setData("text/plain","")});a("#table_language_list tbody > tr").on("dragend",function(){a(this).removeClass("dragging")});
a("#table_language_list tbody").on("dragover",function(d){d.preventDefault();a(this).addClass("dragover")});a("#table_language_list tbody > tr").on("dragleave",function(){a(this).removeClass("dragover")});a("#table_language_list tbody > tr").on("drop",function(d){d.preventDefault();a(this).removeClass("dragover");d=a(".dragging");const c=a(this);d.index()<c.index()?d.insertAfter(c):d.insertBefore(c);w()});a("#table_language_list tbody > tr").on("dragend",function(){a(this).removeClass("dragging")});
a(document).on("click",".reset-btn",I);M.on("click",async function(){let d=!1;if(""==a(A).val())return k.fire({icon:"error",title:"Oops...",html:"Please enter URL engine!!!"}),!1;var c=a("#table_language_list tbody tr");if(2>=c.length&&"-----"===a("#table_language_list tbody tr:eq(1)> td select[name='language-selection'] option:selected").val())return k.fire({icon:"error",title:"Oops...",html:"Please select language list!"}),!1;if("-----"!==a("#table_language_list tbody tr:eq(1)> td select[name='language-selection'] option:selected").val()&&
1==a("select[name='default_lang'] option").length)return k.fire({icon:"error",title:"Oops...",html:"Language list and Lnaguage default not match!<br>Plase click Reflection button!"}),!1;if(a("select[name='default_lang'] option").length==c.length)a("select[name='default_lang'] option").slice(1).each(function(m){let n=a(this).val();if(a(`#table_language_list tbody tr:eq(${m+1})> td input[name='code_iso']`).val()!==n)return d=!0,k.fire({icon:"error",title:"Oops...",html:"Language list and Lnaguage default not match!<br>Plase click Reflection button!"}),
!1});else if(a("select[name='default_lang'] option").length!=c.length)return d=!0,k.fire({icon:"error",title:"Oops...",html:"Language list and Lnaguage default not match!<br>Plase click Reflection button!"}),!1;c=a("#table_translate_field tbody tr").length;var h=!1,b=[];for(var e=1;e<c;e++){var f=a(`#table_translate_field tbody tr:eq(${e})> td input[type="text"]`).val();if(""===f)return d=h=!0,k.fire({icon:"error",title:"Oops...",html:"Please Input all of Item!!"}),!1;if(b.includes(f))return h=d=
!0,k.fire({icon:"error",title:"Oops...",html:`Have the same Item "${f}"!!`}),!1;b.push(f)}if(!h)for(h=1;h<c;h++){var g=h;b=2;e=[];f=[];let m=[],n=[],J=!1,K=!1;for await(var l of a(`#table_translate_field > tbody > tr:eq(${g}) > td select[name='select_field_translate'] option:selected`)){let t=a(l).val();g=a(l).attr("subtable_check");if(!f.includes(g)&&1<=f.length&&g){k.fire({icon:"error",title:"Oops...",html:`If a ${f[0]} is selected in any of the other options, it must be a ${f[0]}.!!`});d=!0;return}f.push(g);
if(e.includes(t)){k.fire({icon:"error",title:"Oops...",html:"Have the same fields!!"});return}""!=t&&e.push(t);t&&b--;for await(let Q of B.properties)if(g=Q,"SUBTABLE"===g.type)g.fields.forEach(function(E){t==E.code&&(J=!0,!n.includes(E.type)&&1<=n.length?(k.fire({icon:"error",title:"Oops...",html:`If a ${n[0]} is selected in any of the other options, it must be a ${n[0]}.!!`}),d=!0):n.push(E.type))});else if(t==g.code){K=!0;if(!m.includes(g.type)&&1<=m.length){k.fire({icon:"error",title:"Oops...",
html:`If a ${m[0]} is selected in any of the other options, it must be a ${m[0]}.!!`});return}m.push(g.type)}if(J&&K){k.fire({icon:"error",title:"Oops...",html:"If a subtable is selected in any of the other options, it must be a subtable.!!"});return}}if(0<b){k.fire({icon:"error",title:"Oops...",html:"Each row of translate field must be selected more than 1 field "});return}}d||(l=P(),await kintone.plugin.app.setConfig(l,function(){k.fire("Complete","successfully","success").then(function(){return window.location.href=
"../../flow?app="+kintone.app.getId()+"#section=settings"})}))});N.on("click",async function(){return window.location.href="../../"+kintone.app.getId()+"/plugin/"});(async function(){try{const h={app:kintone.app.getId()};(await kintone.api("/k/v1/preview/app/form/layout","GET",h)).layout.forEach(b=>{"GROUP"===b.type?b.layout.forEach(e=>{e.fields.forEach(f=>{"SPACER"===f.type&&a("#table_translate_field tbody tr:eq(0) > td select[name='select_field_space']").append(new Option(f.elementId,f.elementId))})}):
b.fields.forEach(e=>{"SPACER"===e.type&&a("#table_translate_field tbody tr:eq(0) > td select[name='select_field_space']").append(new Option(e.elementId,e.elementId))})});if(jQuery.isEmptyObject(r)){for(var d=0;d<y.length;d++){var c=y[d].language;a("select[name='language-selection']").append(new Option(c,c))}a("#table_language_list > tbody > tr").eq(0).clone(!0).insertAfter(a("#table_language_list > tbody > tr")).eq(0);a("#table_translate_field > tbody > tr").eq(0).clone(!0).insertAfter(a("#table_translate_field > tbody > tr")).eq(0);
w();x()}else{d=JSON.parse(r.language_list);const b=JSON.parse(r.translate_engine),e=JSON.parse(r.translate_fields);a(A).val(b.url);a(F).val(b.headers[0].header);a(G).val(b.headers[1].header);a(H).val(b.headers[2].header);q=b.type;a(`input[name='engine'][value='${q}']`).prop("checked",!0);a(`input[name='tran_direction'][value='${r.translate_direction}']`).prop("checked",!0);D=r.translate_direction;z=a("input[name='engine']:checked").val();let f=await p(q);C([0],f);for(c=1;c<=d.length;c++)a("#table_language_list tbody > tr").eq(0).clone(!0).insertAfter(a("#table_language_list tbody > tr").eq(c-
1)),a(`#table_language_list tbody tr:eq(${c})> td select[name='language-selection']`).val(d[c-1].language),a(`#table_language_list tbody tr:eq(${c})> td input[name='button_label']`).val(d[c-1].button_label),a(`#table_language_list tbody tr:eq(${c})> td input[name='lang_code']`).val(d[c-1].lang_code),a(`#table_language_list tbody tr:eq(${c})> td input[name='code_iso']`).val(d[c-1].iso);await I();a("select[name='default_lang']").val(r.default_language);for(let g=1;g<=e.length;g++)a("#table_translate_field > tbody > tr").eq(0).clone(!0).insertAfter(a("#table_translate_field > tbody > tr").eq(g-
1)),a(`#table_translate_field tbody tr:eq(${g})> td input[name='item_code']`).val(e[g-1].item_code),a(`#table_translate_field tbody tr:eq(${g})> td select[name='select_field_space']`).val(e[g-1].space_element),a(`#table_translate_field tbody tr:eq(${g})> td select[name='select_field_translate']`).each(function(l,m){l=e[g-1].target_fields[l].field;a(m).val(l).change()})}}catch(h){return k.fire("Error",h.message||h,"error")}})()})})(jQuery,Sweetalert2_10.noConflict(!0),kintone.$PLUGIN_ID);
