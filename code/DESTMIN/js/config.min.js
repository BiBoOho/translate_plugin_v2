jQuery.noConflict();
(async function(a,l,L){let v=window.language_pack(),M=a("#save"),N=a("#cancel"),B=a("#tran_url"),H=a("#header_1"),I=a("#header_2"),J=a("#header_3"),w,q=kintone.plugin.app.getConfig(L),C;try{let n={app:kintone.app.getId()};C=await kintone.api("/k/v1/preview/form","GET",n)}catch(n){return l.fire("",n.message||n,"error")}const x=()=>{2===a("#table_language_list tbody > tr").length?a("#table_language_list tbody > tr .removeRowLanguageList").eq(1).hide():a(".removeRowLanguageList").show()},y=()=>{2===
a("#table_translate_field tbody > tr").length?a("#table_translate_field tbody > tr .removeRowTranslateField").hide():a(".removeRowTranslateField").show()};a(document).ready(function(){function n(d){p=d;return z="google_tran_api"==p?v.google_tran_api:"deepl_api"==p?v.deepl_api:"my_memory_api"==p?v.my_memory_api:[]}async function D(d,c){let g,b;for(let e=0;e<d.length;e++){b=d[e];g=a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection'] option:selected").val();c.some(f=>f.language===
g)||"-----"===g||(g="-----");a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection'] > option").remove();a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection']").append(new Option("-----","-----"));for(let f=0;f<c.length;f++){let h=c[f].language;a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection']").append(new Option(h,h))}a("#table_language_list tbody tr:eq("+b+")> td select[name='language-selection']").val(g).change()}A=
a("input[name='engine']:checked").val()}async function O(){let d=[],c="";C.properties.forEach(b=>{"SINGLE_LINE_TEXT"===b.type||"RICH_TEXT"===b.type||"MULTI_LINE_TEXT"===b.type?(c={key:b.code,value:b.label+" ("+b.code+")",subtableCode:""},d.push(c)):"SUBTABLE"===b.type&&b.fields.forEach(e=>{c={key:e.code,value:b.label+" ("+b.code+"."+e.code+")",subtableCode:b.code};d.push(c)})});let g=d.sort((b,e)=>b.value.localeCompare(e.value));for(let b=0;b<a("#table_translate_field tbody tr").length;b++)a.each(g,
function(e,f){e=f.key;let h=f.value;f=f.subtableCode;a(`#table_translate_field tbody tr:eq(${b}) select[name='select_field_translate']`).append("<option value="+e+" subtable_check="+f+"> "+h+"</option>")})}async function K(){let d=!1,c=[],g=a("#table_language_list tbody > tr").length;for(var b=2;b<=g;b++){if("-----"==a("#table_language_list tbody > tr:nth-child("+b+") select[name='language-selection'] option:selected").val()){l.fire({icon:"error",title:"",text:"\u8a00\u8a9e\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\uff01"});
return}if(""==a("#table_language_list tbody > tr:nth-child("+b+") input[name='button_label']").val()){l.fire({icon:"error",title:"",text:"\u8868\u793a\u8a00\u8a9e\u30e9\u30d9\u30eb\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044!"});return}}a("#table_language_list tbody > tr > td select[name='language-selection'] option:selected").each(function(){let e=a(this).val();c.includes(e)?(l.fire({icon:"error",title:"",text:"\u7ffb\u8a33\u5bfe\u8c61\u8a00\u8a9e\u4e00\u89a7\u304c\u91cd\u8907\u3057\u3066\u3044\u307e\u3059!"}),
d=!0):c.push(e)});if(!d){let e=[];b="";a("#table_translate_field tbody tr").each(function(f){0!==f&&a(`#table_translate_field tbody tr:eq(${f})> td select[name='select_field_translate']`).each(function(h){h={row:f,language:a(this).attr("value-for-check-field"),field:a(this).val()};e.push(h)})});a("select[name='default_lang'] > option:selected").val()||(b=a("select[name='default_lang'] > option:selected").val());a("select[name='default_lang'] > option").remove();a("#table_translate_field > thead > tr > th:nth-child(n+3)").remove();
a("#table_translate_field > tbody > tr:nth-child(n+1) > td:nth-child(n+3)").remove();a("select[name='default_lang']").append(new Option("-----",""));for(let f=2;f<=g;f++){let h=a("#table_language_list tbody > tr:nth-child("+f+") input[name='code_iso']").val(),k=a("#table_language_list tbody > tr:nth-child("+f+") select[name='language-selection']").val(),m=a("#table_language_list tbody > tr:nth-child("+f+") input[name='button_label']").val(),r=k+"("+h.toUpperCase()+")";"-----"!==k&&(a("select[name='default_lang']").append("<option value="+
h+" value-for-check="+k+">"+r+"</option>"),h==b&&a("select[name='default_lang']").val(h).change(),a("#table_translate_field > thead > tr").append(`<th class="kintoneplugin-table-th"><span class="title">${m}</span></th>`),a("#table_translate_field > tbody > tr").append(`<td>
                <div class="kintoneplugin-table-td-control">
                  <div class="kintoneplugin-table-td-control-value">
                    <div class="kintoneplugin-input-outer">
                      <div class="kintoneplugin-select">
                        <select name="select_field_translate" value-for-check-field="${k}" class="select_field_translate">
                          <option value="">-----</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </td>`))}await O();a("#table_translate_field tbody tr").each(function(f){let h=f+1;a(`#table_translate_field tbody tr:eq(${h})> td select[name='select_field_translate']`).each(function(k,m){for(k=0;k<e.length;k++){const r=e[k].language;e[k].row==h&&a(m).attr("value-for-check-field")==r&&a(m).val(e[k].field).change()}})});a("#table_translate_field tbody>tr").append('<td style="display: flex;" class="kintoneplugin-table-td-operation">\n              <button type="button" class="kintoneplugin-button-add-row-image addRowTranslateField" title="Add row"></button>\n              <button type="button" class="kintoneplugin-button-remove-row-image removeRowTranslateField" title="Delete this row"></button>\n          </td>');
y()}}let p=a("input[name='engine']:checked").val(),A=a("input[name='engine']:checked").val(),z=v.google_tran_api,E=a("input[name='tran_direction']:checked").val();a(document).on("change","input[name='tran_direction']",function(){a("input[name='tran_direction']").each(function(){a(this).removeAttr("checked")});a(this).prop("checked",!0);E=a("input[name='tran_direction']:checked").val()});a(document).on("change","input[name='engine']",async function(){let d=a(this).val();w=await n(d);let c=[],g=!0;
a("select[name='language-selection']").each(function(b){let e=a(this).val();w.some(f=>f.language===e)||"-----"===e||(g=!1);c.push(b)});g?D(c,w):l.fire({html:"\u8a00\u8a9e\u4e00\u89a7\u304c\u5909\u308f\u308a\u307e\u3059<br>\u5909\u66f4\u3057\u3066\u3082\u3088\u308d\u3057\u3044\u3067\u3057\u3087\u3046\u304b\uff1f",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",cancelButtonText:"\u30ad\u30e3\u30f3\u30bb\u30eb",confirmButtonText:"\u306f\u3044"}).then(b=>{b.isConfirmed?
D(c,w):b.isDismissed&&(n(A),a("input[name='engine'][value="+A+"]").prop("checked",!0))})});const P=()=>{let d={type:p,url:a(B).val(),headers:[{header:a(H).val()||""},{header:a(I).val()||""},{header:a(J).val()||""}]},c=[];a("#table_language_list > tbody tr").each(function(b){0!==b&&c.push({language:a(`#table_language_list tbody tr:eq(${b})> td select[name='language-selection'] option:selected`).val(),button_label:a(`#table_language_list tbody tr:eq(${b})> td input[name='button_label']`).val(),lang_code:a(`#table_language_list tbody tr:eq(${b})> td input[name='lang_code']`).val(),
iso:a(`#table_language_list tbody tr:eq(${b})> td input[name='code_iso']`).val()})});let g=[];a("#table_translate_field tbody tr").each(function(b){if(0!==b){let e=[];a(`#table_translate_field tbody tr:eq(${b})> td select[name='select_field_translate']`).each(function(f){f={iso:a(`#table_language_list tbody tr:eq(${f+1})> td input[name='code_iso']`).val(),field:a(this).val()};e.push(f)});g.push({item_code:a(`#table_translate_field tbody tr:eq(${b})> td input[name='item_code']`).val(),space_element:a(`#table_translate_field tbody tr:eq(${b})> td select[name='select_field_space'] option:selected`).val(),
target_fields:e})}});return{translate_direction:E,translate_engine:JSON.stringify(d),language_list:JSON.stringify(c),default_language:a("select[name='default_lang'] option:selected").val(),translate_fields:JSON.stringify(g)}};a(document).on("click",".addRowLanguageList",function(){let d=a("#table_language_list tbody > tr").eq(0).clone(!0);a(this).parent().parent().after(d);x()});a(document).on("click",".addRowTranslateField",function(){let d=a("#table_translate_field > tbody > tr").eq(0).clone(!0);
a(this).parent().parent().after(d);y()});a(document).on("click",".removeRowLanguageList",function(){a(this).parent("td").parent("tr").remove();x()});a(document).on("click",".removeRowTranslateField",function(){a(this).parent("td").parent("tr").remove();y()});a(document).on("change","select[name='language-selection']",function(){let d=a(this).val();if("-----"==d){var c=a(this).parents("tr").index()+1;a(`#table_language_list tbody > tr:nth-child(${c}) input[name='code_iso']`).val("");a(`#table_language_list tbody > tr:nth-child(${c}) input[name='lang_code']`).val("")}else{c=
z.filter(function(e){return e.language===d});let g=c[0].iso,b=c[0].code;c=a(this).parents("tr").index()+1;a(`#table_language_list tbody > tr:nth-child(${c}) > td input[name='code_iso']`).val(g.toUpperCase());a(`#table_language_list tbody > tr:nth-child(${c}) > td input[name='lang_code']`).val(b)}});a("#table_language_list tbody > tr").on("dragstart",function(d){a(this).addClass("dragging");d.originalEvent.dataTransfer.setData("text/plain","")});a("#table_language_list tbody > tr").on("dragend",function(){a(this).removeClass("dragging")});
a("#table_language_list tbody").on("dragover",function(d){d.preventDefault();a(this).addClass("dragover")});a("#table_language_list tbody > tr").on("dragleave",function(){a(this).removeClass("dragover")});a("#table_language_list tbody > tr").on("drop",function(d){d.preventDefault();a(this).removeClass("dragover");d=a(".dragging");const c=a(this);d.index()<c.index()?d.insertAfter(c):d.insertBefore(c);x()});a("#table_language_list tbody > tr").on("dragend",function(){a(this).removeClass("dragging")});
a(document).on("click",".reset-btn",K);M.on("click",async function(){let d=!1;if(""==a(B).val())return l.fire({icon:"error",title:"",html:"\u7ffb\u8a33\u30a8\u30f3\u30b8\u30f3\u306eURL\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044!"}),!1;var c=a("#table_language_list tbody tr");if(2>=c.length&&"-----"===a("#table_language_list tbody tr:eq(1)> td select[name='language-selection'] option:selected").val())return l.fire({icon:"error",title:"",html:"\u8a00\u8a9e\u3092\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044\uff01"}),
!1;if("-----"!==a("#table_language_list tbody tr:eq(1)> td select[name='language-selection'] option:selected").val()&&1==a("select[name='default_lang'] option").length)return l.fire({icon:"error",title:"",html:"\u300c \u53cd\u6620\u300d\u30dc\u30bf\u30f3\u62bc\u3057\u3066\u3001<br>\u7ffb\u8a33\u5bfe\u8c61\u8a00\u8a9e\u4e00\u89a7\u3092\u53cd\u6620\u3057\u3066\u304f\u3060\u3055\u3044!"}),!1;if(a("select[name='default_lang'] option").length==c.length)a("select[name='default_lang'] option").slice(1).each(function(k){let m=
a(this).val();if(a(`#table_language_list tbody tr:eq(${k+1})> td input[name='code_iso']`).val()!==m)return d=!0,l.fire({icon:"error",title:"",html:"\u300c \u53cd\u6620\u300d\u30dc\u30bf\u30f3\u62bc\u3057\u3066\u3001<br>\u7ffb\u8a33\u5bfe\u8c61\u8a00\u8a9e\u4e00\u89a7\u3092\u53cd\u6620\u3057\u3066\u304f\u3060\u3055\u3044!"}),!1});else if(a("select[name='default_lang'] option").length!=c.length)return d=!0,l.fire({icon:"error",title:"",html:"\u300c \u53cd\u6620\u300d\u30dc\u30bf\u30f3\u62bc\u3057\u3066\u3001<br>\u7ffb\u8a33\u5bfe\u8c61\u8a00\u8a9e\u4e00\u89a7\u3092\u53cd\u6620\u3057\u3066\u304f\u3060\u3055\u3044!"}),
!1;c=a("#table_translate_field tbody tr").length;var g=!1,b=[],e="";for(var f=1;f<c;f++){e=a(`#table_translate_field tbody tr:eq(${f})> td input[type="text"]`).val();if(""===e)return d=g=!0,l.fire({icon:"error",title:"",html:"\u9805\u76ee\u30b3\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044!"}),!1;if(b.includes(e))return g=d=!0,l.fire({icon:"error",title:"",html:`\u9805\u76ee\u30b3\u30fc\u30c9\u304c${e}\u91cd\u8907\u3057\u3066\u3044\u307e\u3059!`}),!1;b.push(e)}if(!g)for(g=1;g<
c;g++){b=[];e=[];f=[];let k=[],m=!1,r=!1;for await(var h of a(`#table_translate_field > tbody > tr:eq(${g}) > td select[name='select_field_translate'] option:selected`)){let t=a(h).val(),F=a(h).attr("subtable_check");if(b.includes(t)){l.fire({icon:"error",title:"",html:"\u7ffb\u8a33\u9805\u76ee\u5b9a\u7fa9\u306e\u7ffb\u8a33\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\uff12\u30d5\u30a3\u30fc\u30eb\u30c9\u4ee5\u4e0a\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044!"});return}""!=t&&b.push(t);
if(!e.includes(F)&&1<=e.length&&F){l.fire({icon:"error",title:"",html:"\u7ffb\u8a33\u9805\u76ee\u5b9a\u7fa9\u306e\u7ffb\u8a33\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\u540c\u3058\u30bf\u30a4\u30d7\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044!"});d=!0;return}e.push(F);for await(let u of C.properties)if("SUBTABLE"===u.type)u.fields.forEach(function(G){t==G.code&&(m=!0,!k.includes(G.type)&&1<=k.length?(l.fire({icon:"error",title:"",html:"\u7ffb\u8a33\u9805\u76ee\u5b9a\u7fa9\u306e\u7ffb\u8a33\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\u540c\u3058\u30bf\u30a4\u30d7\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044!"}),
d=!0):k.push(G.type))});else if(t==u.code){r=!0;if(!f.includes(u.type)&&1<=f.length){l.fire({icon:"error",title:"",html:"\u7ffb\u8a33\u9805\u76ee\u5b9a\u7fa9\u306e\u7ffb\u8a33\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\u540c\u3058\u30bf\u30a4\u30d7\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044!"});return}f.push(u.type)}if(m&&r){l.fire({icon:"error",title:"",html:"\u7ffb\u8a33\u9805\u76ee\u5b9a\u7fa9\u306e\u7ffb\u8a33\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\u540c\u3058\u30bf\u30a4\u30d7\u306e\u30d5\u30a3\u30fc\u30eb\u30c9\u3092\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044!"});
return}}if(2>b.length){l.fire({icon:"error",title:"",html:"\u7ffb\u8a33\u9805\u76ee\u5b9a\u7fa9\u306e\u7ffb\u8a33\u5bfe\u8c61\u30d5\u30a3\u30fc\u30eb\u30c9\u306f\u3001\uff12\u30d5\u30a3\u30fc\u30eb\u30c9\u4ee5\u4e0a\u6307\u5b9a\u3057\u3066\u304f\u3060\u3055\u3044!"});return}}d||(h=P(),await kintone.plugin.app.setConfig(h,function(){l.fire("\u4fdd\u5b58\u5b8c\u4e86","\u30d7\u30e9\u30b0\u30a4\u30f3\u8a2d\u5b9a\u3092\u4fdd\u5b58\u3057\u307e\u3057\u305f","success").then(function(){return window.location.href=
"../../flow?app="+kintone.app.getId()+"#section=settings"})}))});N.on("click",async function(){return window.location.href="../../"+kintone.app.getId()+"/plugin/"});(async function(){try{const g={app:kintone.app.getId()};(await kintone.api("/k/v1/preview/app/form/layout","GET",g)).layout.forEach(b=>{"GROUP"===b.type?b.layout.forEach(e=>{e.fields.forEach(f=>{"SPACER"===f.type&&a("#table_translate_field tbody tr:eq(0) > td select[name='select_field_space']").append(new Option(f.elementId,f.elementId))})}):
b.fields.forEach(e=>{"SPACER"===e.type&&a("#table_translate_field tbody tr:eq(0) > td select[name='select_field_space']").append(new Option(e.elementId,e.elementId))})});if(jQuery.isEmptyObject(q)){for(var d=0;d<z.length;d++){var c=z[d].language;a("select[name='language-selection']").append(new Option(c,c))}a("#table_language_list > tbody > tr").eq(0).clone(!0).insertAfter(a("#table_language_list > tbody > tr")).eq(0);a("#table_translate_field > tbody > tr").eq(0).clone(!0).insertAfter(a("#table_translate_field > tbody > tr")).eq(0);
x();y()}else{d=JSON.parse(q.language_list);const b=JSON.parse(q.translate_engine),e=JSON.parse(q.translate_fields);a(B).val(b.url);a(H).val(b.headers[0].header);a(I).val(b.headers[1].header);a(J).val(b.headers[2].header);p=b.type;a(`input[name='engine'][value='${p}']`).prop("checked",!0);a(`input[name='tran_direction'][value='${q.translate_direction}']`).prop("checked",!0);E=q.translate_direction;A=a("input[name='engine']:checked").val();let f=await n(p);D([0],f);for(c=1;c<=d.length;c++)a("#table_language_list tbody > tr").eq(0).clone(!0).insertAfter(a("#table_language_list tbody > tr").eq(c-
1)),a(`#table_language_list tbody tr:eq(${c})> td select[name='language-selection']`).val(d[c-1].language),a(`#table_language_list tbody tr:eq(${c})> td input[name='button_label']`).val(d[c-1].button_label),a(`#table_language_list tbody tr:eq(${c})> td input[name='lang_code']`).val(d[c-1].lang_code),a(`#table_language_list tbody tr:eq(${c})> td input[name='code_iso']`).val(d[c-1].iso);await K();a("select[name='default_lang']").val(q.default_language);for(let h=1;h<=e.length;h++)a("#table_translate_field > tbody > tr").eq(0).clone(!0).insertAfter(a("#table_translate_field > tbody > tr").eq(h-
1)),a(`#table_translate_field tbody tr:eq(${h})> td input[name='item_code']`).val(e[h-1].item_code),a(`#table_translate_field tbody tr:eq(${h})> td select[name='select_field_space']`).val(e[h-1].space_element),a(`#table_translate_field tbody tr:eq(${h})> td select[name='select_field_translate']`).each(function(k,m){k=e[h-1].target_fields[k].field;0<a(m).find(`option[value='${k}']`).length?a(m).val(k).change():a(m).val("").change()})}}catch(g){return l.fire("",g.message||g,"error")}})()})})(jQuery,
Sweetalert2_10.noConflict(!0),kintone.$PLUGIN_ID);
